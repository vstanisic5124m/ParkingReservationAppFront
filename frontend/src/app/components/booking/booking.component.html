<!-- html -->
<div class="booking-container">
    <nav class="navbar">
        <div class="navbar-brand">
            <h1>ðŸš— Parking Reservation</h1>
        </div>
        <div class="navbar-user">
            <span class="user-name">{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
            <button class="btn btn-logout" (click)="logout()">Logout</button>
        </div>
    </nav>

    <div class="booking-content">
        <div class="date-selector">
            <h2>Select Date</h2>
            <input class="date-input" type="date" [value]="formatDate(selectedDate)" (change)="onDateChange($event)" />
        </div>

        <div class="parking-section">
            <div class="debug-panel" style="margin-bottom:1rem; font-size:0.9rem; color:#555;">
                <strong>Debug:</strong>
                <span>Available: {{ availableCount }}</span>
                <span style="margin-left:1rem">Random picks: {{ getRandomOccupiedArray().length }}</span>
                <div style="margin-top:0.5rem">IDs: {{ getRandomOccupiedArray() }}</div>
                <div style="margin-top:0.5rem; font-size:0.9rem; color:#444;">
                    <strong>Auth debug:</strong>
                    <span style="margin-left:0.5rem">Has token: {{ !!authService.getToken() }}</span>
                </div>
            </div>

            <h3>Dvoriste (50 mesta) â€” Table view</h3>
            <div class="parking-tables-wrapper">
                <table class="parking-table yard-table" role="grid" aria-label="Yard parking table">
                    <caption>Yard layout â€” 5 rows Ã— 10 columns</caption>
                    <tbody>
                    <tr *ngFor="let row of getYardRows()" role="row">
                        <td *ngFor="let col of getYardCols()"
                            role="gridcell"
                            class="grid-cell">
                            <ng-container *ngIf="getSpaceAtPosition('YARD', row, col) as space; else emptyYard">
                                <button class="space-btn"
                                        (click)="onSpaceClick(space)"
                                        [ngClass]="getUiClass(space)"
                                        [class.ui-selected]="isSelected(space)"
                                        [class.random-occupied]="isRandomDecorated(space)"
                                        [class.clickable]="(isAvailable(space) || isMyReservation(space) || isRandomDecorated(space))"
                                        [style.backgroundColor]="getBackgroundColor(space)"
                                        [style.color]="getTextColor(space)"
                                        [style.borderColor]="getBorderColor(space)"
                                        [attr.id]="space.id ? 'spot-'+space.id : null"
                                        [attr.data-spot-id]="space.id"
                                        aria-label="Yard spot {{ space.spotNumber }}"
                                        [disabled]="(!isAvailable(space) && !isMyReservation(space) && !isRandomDecorated(space))"
                                        [title]="isRandomDecorated(space) ? 'Randomly decorated spot' : ''">
                                    <span *ngIf="isRandomDecorated(space)">â˜…</span>
                                    <span *ngIf="!isRandomDecorated(space) && isSelected(space)">âœ”</span>
                                    <span *ngIf="!isRandomDecorated(space) && !isSelected(space)">{{ space.spotNumber }}</span>
                                </button>
                            </ng-container>
                            <ng-template #emptyYard>
                                <!-- Show a placeholder disabled button with computed spot number so grid is visible -->
                                <button class="space-btn placeholder" disabled aria-hidden="true">
                                    {{ getSpotNumber('YARD', row, col) }}
                                </button>
                            </ng-template>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <h3>Garaza (100 mesta) â€” Table view</h3>
                <table class="parking-table garage-table" role="grid" aria-label="Garage parking table">
                    <caption>Garage layout â€” 10 rows Ã— 10 columns</caption>
                    <tbody>
                    <tr *ngFor="let row of getGarageRows()" role="row">
                        <td *ngFor="let col of getGarageCols()"
                            role="gridcell"
                            class="grid-cell">
                            <ng-container *ngIf="getSpaceAtPosition('GARAGE', row, col) as space; else emptyGarage">
                                <button class="space-btn"
                                        (click)="onSpaceClick(space)"
                                        [ngClass]="getUiClass(space)"
                                        [class.ui-selected]="isSelected(space)"
                                        [class.random-occupied]="isRandomDecorated(space)"
                                        [class.clickable]="(isAvailable(space) || isMyReservation(space) || isRandomDecorated(space))"
                                        [style.backgroundColor]="getBackgroundColor(space)"
                                        [style.color]="getTextColor(space)"
                                        [style.borderColor]="getBorderColor(space)"
                                        [attr.id]="space.id ? 'spot-'+space.id : null"
                                        [attr.data-spot-id]="space.id"
                                        aria-label="Garage spot {{ space.spotNumber }}"
                                        [disabled]="(!isAvailable(space) && !isMyReservation(space) && !isRandomDecorated(space))"
                                        [title]="isRandomDecorated(space) ? 'Randomly decorated spot' : ''">
                                    <span *ngIf="isRandomDecorated(space)">â˜…</span>
                                    <span *ngIf="!isRandomDecorated(space) && isSelected(space)">âœ”</span>
                                    <span *ngIf="!isRandomDecorated(space) && !isSelected(space)">{{ space.spotNumber }}</span>
                                </button>
                            </ng-container>
                            <ng-template #emptyGarage>
                                <button class="space-btn placeholder" disabled aria-hidden="true">
                                    {{ getSpotNumber('GARAGE', row, col) }}
                                </button>
                            </ng-template>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Legend -->
            <div class="legend">
                <h4>Legend:</h4>
                <div class="legend-item">
                    <div class="legend-box space-available"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-occupied"></div>
                    <span>Occupied</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-my-reservation"></div>
                    <span>Selected / Booking</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-cancelled"></div>
                    <span>Owner Cancelled</span>
                </div>
            </div>
        </div>

        <!-- Booking Popup -->
        <div *ngIf="showBookingPopup" class="popup-overlay" (click)="closePopup()">
            <div class="popup-content" (click)="$event.stopPropagation()">
                <h3>Potvrdite rezervaciju</h3>
                <p>Da li zelite da rezervisete ovo parking mesto? #{{ selectedSpace?.spotNumber }}?</p>
                <p><strong>Date:</strong> {{ formatDate(selectedDate) }}</p>
                <p><strong>Type:</strong> {{ selectedSpace?.parkingType }}</p>

                <div *ngIf="popupError" class="popup-error">{{ popupError }}</div>

                <div class="popup-actions">
                    <button class="btn btn-primary" (click)="confirmBooking()" [disabled]="bookingInProgress">
                        {{ bookingInProgress ? 'Booking...' : 'Yes, Book It' }}
                    </button>
                    <button class="btn btn-secondary" (click)="closePopup()" [disabled]="bookingInProgress">Cancel</button>
                </div>

                <p class="popup-note">ðŸ“§ You will receive an email confirmation after booking.</p>
                <p *ngIf="emailNotificationMessage" class="email-note">{{ emailNotificationMessage }}</p>
            </div>
        </div>

        <!-- Cancel Popup -->
        <div *ngIf="showCancelPopup" class="popup-overlay" (click)="closePopup()">
            <div class="popup-content" (click)="$event.stopPropagation()">
                <h3>Otkazi rezervaciju</h3>
                <p>Da li zelite da otkazete ovo parking mesto ? #{{ selectedSpace?.spotNumber }}?</p>
                <p><strong>Date:</strong> {{ formatDate(selectedDate) }}</p>

                <div *ngIf="popupError" class="popup-error">{{ popupError }}</div>

                <div class="popup-actions">
                    <button class="btn btn-danger" (click)="confirmCancel()" [disabled]="cancellingReservation">
                        {{ cancellingReservation ? 'Cancelling...' : 'Yes, Cancel It' }}
                    </button>
                    <button class="btn btn-secondary" (click)="closePopup()" [disabled]="cancellingReservation">Keep Reservation</button>
                </div>

                <p class="popup-note">ðŸ“§ You will receive an email confirmation after cancellation.</p>
                <p *ngIf="emailNotificationMessage" class="email-note">{{ emailNotificationMessage }}</p>
            </div>
        </div>
    </div>
</div>
