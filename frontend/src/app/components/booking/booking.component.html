<div class="booking-container">
    <nav class="navbar">
        <div class="navbar-brand">
            <h1>ðŸš— Parking Reservation</h1>
        </div>
        <div class="navbar-user">
            <span class="user-name">{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span>
            <button class="btn btn-logout" (click)="logout()">Logout</button>
        </div>
    </nav>

    <div class="booking-content">
        <div class="date-selector">
            <h2>Select Date</h2>
            <input class="date-input" type="date" [value]="formatDate(selectedDate)" (change)="onDateChange($event)" />
        </div>

        <div class="parking-section">
            <h3>Dvoriste (50 mesta)</h3>
            <div class="parking-grid yard-grid">
                <div *ngFor="let row of getYardRows()" class="parking-row">
                    <div
                            *ngFor="let col of getYardCols()"
                            class="parking-space"
                            [class]="getSpaceClass(getSpaceAtPosition('YARD', row, col)!)"
                            [class.clickable]="getSpaceAtPosition('YARD', row, col)?.status === 'available' || getSpaceAtPosition('YARD', row, col)?.status === 'my-reservation'"
                            (click)="onSpaceClick(getSpaceAtPosition('YARD', row, col)!)"
                            [attr.id]="getSpaceAtPosition('YARD', row, col)?.id ? 'spot-'+getSpaceAtPosition('YARD', row, col)?.id : null"
                            [attr.data-spot-id]="getSpaceAtPosition('YARD', row, col)?.id"
                            aria-label="Yard spot {{ getSpaceAtPosition('YARD', row, col)?.spotNumber }}"
                            role="button"
                    >
                        {{ getSpaceAtPosition('YARD', row, col)?.spotNumber }}
                    </div>
                </div>
            </div>

            <h3>Garaza (100 mesta)</h3>
            <div class="parking-grid garage-grid">
                <div *ngFor="let row of getGarageRows()" class="parking-row">
                    <div
                            *ngFor="let col of getGarageCols()"
                            class="parking-space"
                            [class]="getSpaceClass(getSpaceAtPosition('GARAGE', row, col)!)"
                            [class.clickable]="getSpaceAtPosition('GARAGE', row, col)?.status === 'available' || getSpaceAtPosition('GARAGE', row, col)?.status === 'my-reservation'"
                            (click)="onSpaceClick(getSpaceAtPosition('GARAGE', row, col)!)"
                            [attr.id]="getSpaceAtPosition('GARAGE', row, col)?.id ? 'spot-'+getSpaceAtPosition('GARAGE', row, col)?.id : null"
                            [attr.data-spot-id]="getSpaceAtPosition('GARAGE', row, col)?.id"
                            aria-label="Garage spot {{ getSpaceAtPosition('GARAGE', row, col)?.spotNumber }}"
                            role="button"
                    >
                        {{ getSpaceAtPosition('GARAGE', row, col)?.spotNumber }}
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <h4>Legend:</h4>
                <div class="legend-item">
                    <div class="legend-box space-available"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-occupied"></div>
                    <span>Occupied</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-my-reservation"></div>
                    <span>My Reservation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box space-cancelled"></div>
                    <span>Owner Cancelled</span>
                </div>
            </div>
        </div>

        <!-- Booking Popup -->
        <div *ngIf="showBookingPopup" class="popup-overlay" (click)="closePopup()">
            <div class="popup-content" (click)="$event.stopPropagation()">
                <h3>Potvrdite rezervaciju</h3>
                <p>Da li zelite da rezervisete ovo parking mesto? #{{ selectedSpace?.spotNumber }}?</p>
                <p><strong>Date:</strong> {{ formatDate(selectedDate) }}</p>
                <p><strong>Type:</strong> {{ selectedSpace?.parkingType }}</p>

                <div *ngIf="popupError" class="popup-error">{{ popupError }}</div>

                <div class="popup-actions">
                    <button class="btn btn-primary" (click)="confirmBooking()" [disabled]="bookingInProgress">
                        {{ bookingInProgress ? 'Booking...' : 'Yes, Book It' }}
                    </button>
                    <button class="btn btn-secondary" (click)="closePopup()" [disabled]="bookingInProgress">Cancel</button>
                </div>

                <p class="popup-note">ðŸ“§ You will receive an email confirmation after booking.</p>
                <p *ngIf="emailNotificationMessage" class="email-note">{{ emailNotificationMessage }}</p>
            </div>
        </div>

        <!-- Cancel Popup -->
        <div *ngIf="showCancelPopup" class="popup-overlay" (click)="closePopup()">
            <div class="popup-content" (click)="$event.stopPropagation()">
                <h3>Otkazi rezervaciju</h3>
                <p>Da li zelite da otkazete ovo parking mesto ? #{{ selectedSpace?.spotNumber }}?</p>
                <p><strong>Date:</strong> {{ formatDate(selectedDate) }}</p>

                <div *ngIf="popupError" class="popup-error">{{ popupError }}</div>

                <div class="popup-actions">
                    <button class="btn btn-danger" (click)="confirmCancel()" [disabled]="cancellingReservation">
                        {{ cancellingReservation ? 'Cancelling...' : 'Yes, Cancel It' }}
                    </button>
                    <button class="btn btn-secondary" (click)="closePopup()" [disabled]="cancellingReservation">Keep Reservation</button>
                </div>

                <p class="popup-note">ðŸ“§ You will receive an email confirmation after cancellation.</p>
                <p *ngIf="emailNotificationMessage" class="email-note">{{ emailNotificationMessage }}</p>
            </div>
        </div>
    </div>
</div>